name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_call:

concurrency:
  group: ci-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Run vet
      run: go vet ./...

    - name: Check Go formatting
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "Please run 'gofmt -s -w .' to format your code"
          gofmt -s -l .
          exit 1
        fi

    - uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install prettier
      run: npm install --no-save prettier

    - name: Check markdown formatting
      run: |
        npx prettier --check "**/*.md" || (echo "Please run 'npx prettier --write \"**/*.md\"' to format your markdown files" && exit 1)

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Download dependencies
      run: go mod download

    - name: Run fast tests
      run: go test -v -race ./internal/...

    - uses: getsentry/action-github-app-token@a0061014b82a6a5d6aeeb3b824aced47e3c3a7ef
      id: get_app_token
      with:
        app_id: ${{ secrets.REMOTEPROC_RUNTIME_REPO_ACCESS_APP_ID }}
        private_key: ${{ secrets.REMOTEPROC_RUNTIME_REPO_ACCESS_PRIVATE_KEY }}

    - name: Download Remoteproc Simulator
      uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05 # v1.12
      with:
        repository: Arm-Debug/remoteproc-simulator
        latest: true
        fileName: remoteproc-simulator_*_linux_amd64.tar.gz
        out-file-path: remoteproc-simulator
        extract: true
        token: ${{ steps.get_app_token.outputs.token }}

    - name: Install Remoteproc Simulator
      run: echo "$PWD/remoteproc-simulator" >> $GITHUB_PATH

    - name: Set up Lima
      uses: lima-vm/lima-actions/setup@03b96d61959e83b2c737e44162c3088e81de0886 # v1.0.1
      id: lima-actions-setup

    - name: Cache ~/.cache/lima
      uses: actions/cache@v4
      with:
        path: ~/.cache/lima
        key: lima-${{ steps.lima-actions-setup.outputs.version }}

    - name: Run e2e tests
      run: go test -v ./e2e/...
